# Userdata Privacy

Cluster API Provider AWS bootstraps EC2 instances to create and join Kubernetes clusters using instance user data.
Because Kubernetes clusters are secured using TLS using multiple Certificate Authorities, these are generated by
Cluster API and injected into the user data. It is important to note that without the configuring of host firewalls, processes can
retrieve instance userdata from http://169.254.169.254/latest/api/token

## How Cluster API secures TLS secrets

In 0.5.x/v1alpha3, by default, Cluster API Provider AWS will use [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/)
to store the actual userdata in encrypted form. The normal unencrypted userdata uses a boot script to download the encrypted userdata secret
using instance profile permissions, immediately deletes it from AWS Secrets Manager, and then executes it.

To avoid guessing keys in the AWS Secrets Manager key-value store and to prevent collisions, the key is an encoding the
Kubernetes namespace, cluster name and instance name, with a random string appended, providing ~256-bits of entropy.

Cluster API Provider AWS also stores the secret ARN in the AWSMachine spec, and will delete the secret if it isn't already deleted and
the machine has registered successfully against the workload cluster API server as a node.
Cluster API Provider AWS will also attempt deletion of the secret if the AWSMachine is otherwise deleted or the EC2 instance
is terminated or failed.

This method is only compatible with operating systems and distributions using
[cloud-init](https://cloudinit.readthedocs.io/en/latest/topics/format.html#mime-multi-part-archive). If you are using a different bootstrap
process, you will need to co-ordinate this externally and set the following in the specification of the AWSMachine types to disable the use
of a cloud-init boothook:

``` yaml
cloudInit:
  disableUserdataPrivacy: true
```
